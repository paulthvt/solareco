name: Build and Release

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-and-release:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      released: ${{ steps.get-version.outputs.released }}
      should-release: ${{ steps.check-release.outputs.should-release }}

    steps:
      - name: Run information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Git ref:    ${{ github.ref }}"
          echo "GH actor:   ${{ github.actor }}"
          echo "SHA:        ${{ github.sha }}"

      - name: Checkout Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Check if release should run
        id: check-release
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "Pull request - skipping release"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || \
               [[ "${{ github.ref }}" == "refs/heads/develop" ]] || \
               [[ "${{ github.ref }}" == refs/heads/release/* ]] || \
               [[ "${{ github.ref }}" == refs/heads/hotfix/* ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "Branch eligible for release"
          else
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "Branch not eligible for release"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build project (non-release)
        if: steps.check-release.outputs.should-release == 'false'
        run: ./gradlew build

      - name: Run tests (non-release)
        if: steps.check-release.outputs.should-release == 'false'
        run: ./gradlew test

      - name: Archive test results (non-release)
        if: steps.check-release.outputs.should-release == 'false' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            composeApp/build/reports/tests/
            composeApp/build/test-results/
          retention-days: 7

      - name: Set up Node.js
        if: steps.check-release.outputs.should-release == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: NPM Packages Installation
        if: steps.check-release.outputs.should-release == 'true'
        run: npm ci

      - name: Generate GitHub App Token
        if: steps.check-release.outputs.should-release == 'true'
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SEMANTIC_RELEASE_APP_ID }}
          private-key: ${{ secrets.SEMANTIC_RELEASE_APP_PRIVATE_KEY }}

      - name: Retrieve GitHub App User ID
        if: steps.check-release.outputs.should-release == 'true'
        id: get-user-id
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: echo "user-id=$(gh api "/users/${{ steps.generate-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Prepare local.properties for signing
        if: steps.check-release.outputs.should-release == 'true'
        env:
          RELEASE_STORE_FILE: ${{ secrets.RELEASE_STORE_FILE }}
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          if [ -n "$RELEASE_STORE_FILE" ]; then
            echo "RELEASE_STORE_FILE=$RELEASE_STORE_FILE" >> local.properties
            echo "RELEASE_STORE_PASSWORD=$RELEASE_STORE_PASSWORD" >> local.properties
            echo "RELEASE_KEY_ALIAS=$RELEASE_KEY_ALIAS" >> local.properties
            echo "RELEASE_KEY_PASSWORD=$RELEASE_KEY_PASSWORD" >> local.properties
          fi

      - name: Create google-services.json from template and secrets
        if: steps.check-release.outputs.should-release == 'true'
        shell: bash
        env:
          FIREBASE_PROJECT_NUMBER: ${{ secrets.FIREBASE_PROJECT_NUMBER }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_ANDROID_API_KEY: ${{ secrets.FIREBASE_ANDROID_API_KEY }}
        run: |
          # Use template and replace placeholders with actual values
          sed -e "s/FIREBASE_PROJECT_NUMBER/$FIREBASE_PROJECT_NUMBER/g" \
              -e "s/FIREBASE_PROJECT_ID/$FIREBASE_PROJECT_ID/g" \
              -e "s/FIREBASE_STORAGE_BUCKET/$FIREBASE_STORAGE_BUCKET/g" \
              -e "s/FIREBASE_ANDROID_APP_ID/$FIREBASE_ANDROID_APP_ID/g" \
              -e "s/FIREBASE_ANDROID_API_KEY/$FIREBASE_ANDROID_API_KEY/g" \
              composeApp/google-services.json.template > composeApp/google-services.json

      - name: Create GoogleService-Info.plist from template and secrets
        if: steps.check-release.outputs.should-release == 'true'
        shell: bash
        env:
          FIREBASE_IOS_API_KEY: ${{ secrets.FIREBASE_IOS_API_KEY }}
          FIREBASE_GCM_SENDER_ID: ${{ secrets.FIREBASE_GCM_SENDER_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          # Use template and replace placeholders with actual values
          sed -e "s/FIREBASE_IOS_API_KEY/$FIREBASE_IOS_API_KEY/g" \
              -e "s/FIREBASE_GCM_SENDER_ID/$FIREBASE_GCM_SENDER_ID/g" \
              -e "s/FIREBASE_PROJECT_ID/$FIREBASE_PROJECT_ID/g" \
              -e "s/FIREBASE_STORAGE_BUCKET/$FIREBASE_STORAGE_BUCKET/g" \
              -e "s/FIREBASE_IOS_APP_ID/$FIREBASE_IOS_APP_ID/g" \
              iosApp/iosApp/GoogleService-Info.plist.template > iosApp/iosApp/GoogleService-Info.plist

      - name: Semantic Release
        if: steps.check-release.outputs.should-release == 'true'
        id: semantic-release
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
          GIT_AUTHOR_NAME: ${{ steps.generate-token.outputs.app-slug }}[bot]
          GIT_AUTHOR_EMAIL: ${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate-token.outputs.app-slug }}[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: ${{ steps.generate-token.outputs.app-slug }}[bot]
          GIT_COMMITTER_EMAIL: ${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate-token.outputs.app-slug }}[bot]@users.noreply.github.com
        run: npx semantic-release

      - name: Get Release Version
        id: get-version
        run: |
          if [[ "${{ steps.check-release.outputs.should-release }}" == "true" ]]; then
            if [ -f .VERSION ]; then
              version=$(cat .VERSION)
              echo "Release version: $version"
              echo "version=$version" >> $GITHUB_OUTPUT
              echo "released=true" >> $GITHUB_OUTPUT
            else
              echo "No version file found - no release was created"
              echo "version=" >> $GITHUB_OUTPUT
              echo "released=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Non-release build - skipping version check"
            echo "version=" >> $GITHUB_OUTPUT
            echo "released=false" >> $GITHUB_OUTPUT
          fi

      - name: Archive Android APK
        if: steps.get-version.outputs.released == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.get-version.outputs.version }}
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Archive Android Bundle
        if: steps.get-version.outputs.released == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-bundle-${{ steps.get-version.outputs.version }}
          path: composeApp/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Archive iOS App
        if: steps.get-version.outputs.released == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ steps.get-version.outputs.version }}
          path: build/iosApp.xcarchive/
          retention-days: 30

      - name: Build Summary (non-release)
        if: steps.check-release.outputs.should-release == 'false'
        run: |
          echo "## Build Successful âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests" >> $GITHUB_STEP_SUMMARY

      - name: Release Summary
        if: steps.get-version.outputs.released == 'true'
        run: |
          echo "## Release ${{ steps.get-version.outputs.version }} ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully released version **${{ steps.get-version.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android APK" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android Bundle (AAB)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… iOS App Archive" >> $GITHUB_STEP_SUMMARY
