name: Build and Release

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-and-release:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      released: ${{ steps.get-version.outputs.released }}
      should-release: ${{ steps.check-release.outputs.should-release }}

    steps:
      - name: Run information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Git ref:    ${{ github.ref }}"
          echo "GH actor:   ${{ github.actor }}"
          echo "SHA:        ${{ github.sha }}"

      - name: Checkout Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Check if release should run
        id: check-release
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "Pull request - skipping release"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || \
               [[ "${{ github.ref }}" == "refs/heads/develop" ]] || \
               [[ "${{ github.ref }}" == refs/heads/release/* ]] || \
               [[ "${{ github.ref }}" == refs/heads/hotfix/* ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "Branch eligible for release"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "Branch not eligible for release"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Setup Xcode
        run: |
          # Use the default Xcode on the runner
          xcodebuild -version
          xcodebuild -showsdks
          # List available destinations
          xcodebuild -project iosApp/iosApp.xcodeproj -scheme iosApp -showdestinations || true

      - name: Build project (non-release) (skip tests)
        if: steps.check-release.outputs.should-release == 'false'
        run: ./gradlew build -x test

      - name: Run tests (non-release)
        if: steps.check-release.outputs.should-release == 'false'
        run: ./gradlew test

      - name: Archive test results (non-release)
        if: steps.check-release.outputs.should-release == 'false' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            composeApp/build/reports/tests/
            composeApp/build/test-results/
          retention-days: 7
      - name: Set up Node.js
        if: steps.check-release.outputs.should-release == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: NPM Packages Installation
        if: steps.check-release.outputs.should-release == 'true'
        run: npm ci

      - name: Decode and setup Android keystore
        if: steps.check-release.outputs.should-release == 'true'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "Setting up keystore from base64-encoded secret..."
            mkdir -p ~/.android
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > ~/.android/release.keystore
            chmod 600 ~/.android/release.keystore
            echo "âœ… Keystore file created at: ~/.android/release.keystore"
            ls -lh ~/.android/release.keystore
          else
            echo "âš ï¸  WARNING: ANDROID_KEYSTORE_BASE64 secret not found. Build will be unsigned."
          fi

      - name: Prepare local.properties for signing
        if: steps.check-release.outputs.should-release == 'true'
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          if [ -f ~/.android/release.keystore ]; then
            echo "RELEASE_STORE_FILE=$HOME/.android/release.keystore" >> local.properties
            echo "RELEASE_STORE_PASSWORD=$RELEASE_STORE_PASSWORD" >> local.properties
            echo "RELEASE_KEY_ALIAS=$RELEASE_KEY_ALIAS" >> local.properties
            echo "RELEASE_KEY_PASSWORD=$RELEASE_KEY_PASSWORD" >> local.properties
            echo "âœ… Signing configuration added to local.properties"
          else
            echo "âš ï¸  Keystore file not found, skipping signing configuration"
          fi

      - name: Create google-services.json from template and secrets
        if: steps.check-release.outputs.should-release == 'true'
        shell: bash
        env:
          FIREBASE_PROJECT_NUMBER: ${{ secrets.FIREBASE_PROJECT_NUMBER }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_ANDROID_API_KEY: ${{ secrets.FIREBASE_ANDROID_API_KEY }}
        run: |
          echo "Creating google-services.json for Firebase/Crashlytics..."
          
          # Check if all required secrets are present
          if [ -z "$FIREBASE_PROJECT_NUMBER" ] || [ -z "$FIREBASE_PROJECT_ID" ] || \
             [ -z "$FIREBASE_STORAGE_BUCKET" ] || [ -z "$FIREBASE_ANDROID_APP_ID" ] || \
             [ -z "$FIREBASE_ANDROID_API_KEY" ]; then
            echo "âš ï¸  WARNING: Some Firebase secrets are missing. Crashlytics may not work properly."
          fi
          
          # Use template and replace placeholders with actual values
          sed -e "s/FIREBASE_PROJECT_NUMBER/$FIREBASE_PROJECT_NUMBER/g" \
              -e "s/FIREBASE_PROJECT_ID/$FIREBASE_PROJECT_ID/g" \
              -e "s/FIREBASE_STORAGE_BUCKET/$FIREBASE_STORAGE_BUCKET/g" \
              -e "s/FIREBASE_ANDROID_APP_ID/$FIREBASE_ANDROID_APP_ID/g" \
              -e "s/FIREBASE_ANDROID_API_KEY/$FIREBASE_ANDROID_API_KEY/g" \
              composeApp/google-services.json.template > composeApp/google-services.json
          
          # Verify the file was created and doesn't contain placeholder text
          if [ -f composeApp/google-services.json ]; then
            echo "âœ… google-services.json created successfully"
            if grep -q "FIREBASE_" composeApp/google-services.json; then
              echo "âš ï¸  WARNING: google-services.json still contains placeholders!"
              cat composeApp/google-services.json
            fi
          else
            echo "âŒ ERROR: Failed to create google-services.json"
            exit 1
          fi

      - name: Create GoogleService-Info.plist from template and secrets
        if: steps.check-release.outputs.should-release == 'true'
        shell: bash
        env:
          FIREBASE_IOS_API_KEY: ${{ secrets.FIREBASE_IOS_API_KEY }}
          FIREBASE_GCM_SENDER_ID: ${{ secrets.FIREBASE_GCM_SENDER_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          # Use template and replace placeholders with actual values
          sed -e "s/FIREBASE_IOS_API_KEY/$FIREBASE_IOS_API_KEY/g" \
              -e "s/FIREBASE_GCM_SENDER_ID/$FIREBASE_GCM_SENDER_ID/g" \
              -e "s/FIREBASE_PROJECT_ID/$FIREBASE_PROJECT_ID/g" \
              -e "s/FIREBASE_STORAGE_BUCKET/$FIREBASE_STORAGE_BUCKET/g" \
              -e "s/FIREBASE_IOS_APP_ID/$FIREBASE_IOS_APP_ID/g" \
              iosApp/iosApp/GoogleService-Info.plist.template > iosApp/iosApp/GoogleService-Info.plist

      - name: Configure Git for semantic-release
        if: steps.check-release.outputs.should-release == 'true'
        env:
          GH_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git

      - name: Semantic Release
        if: steps.check-release.outputs.should-release == 'true'
        id: semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
          GH_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
        run: npx semantic-release

      - name: Get Release Version
        id: get-version
        run: |
          if [[ "${{ steps.check-release.outputs.should-release }}" == "true" ]]; then
            if [ -f .VERSION ]; then
              version=$(cat .VERSION)
              echo "Release version: $version"
              echo "version=$version" >> $GITHUB_OUTPUT
              echo "released=true" >> $GITHUB_OUTPUT
            else
              echo "No version file found - no release was created"
              echo "version=" >> $GITHUB_OUTPUT
              echo "released=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Non-release build - skipping version check"
            echo "version=" >> $GITHUB_OUTPUT
            echo "released=false" >> $GITHUB_OUTPUT
          fi

      - name: Archive Android APK
        if: steps.get-version.outputs.released == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.get-version.outputs.version }}
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Archive Android Bundle
        if: steps.get-version.outputs.released == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-bundle-${{ steps.get-version.outputs.version }}
          path: composeApp/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Archive iOS App
        if: steps.get-version.outputs.released == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ steps.get-version.outputs.version }}
          path: build/iosApp.xcarchive/
          retention-days: 30

      - name: Build Summary (non-release)
        if: steps.check-release.outputs.should-release == 'false'
        run: |
          echo "## Build Successful âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build (tests skipped here)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests (executed in dedicated step)" >> $GITHUB_STEP_SUMMARY

      - name: Release Summary
        if: steps.get-version.outputs.released == 'true'
        run: |
          echo "## Release ${{ steps.get-version.outputs.version }} ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully released version **${{ steps.get-version.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android APK" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android Bundle (AAB)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… iOS Archive (unsigned)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** iOS archive requires signing for distribution. The unsigned archive can be used for verification and can be signed later." >> $GITHUB_STEP_SUMMARY

      - name: Merge main into develop
        if: github.ref == 'refs/heads/main' && steps.get-version.outputs.version != ''
        env:
          GH_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git fetch origin
          if git rev-parse --verify develop >/dev/null 2>&1; then
            git checkout develop
          else
            if git rev-parse --verify origin/develop >/dev/null 2>&1; then
              git checkout -b develop origin/develop
            else
              echo "WARNING: origin/develop does not exist. Aborting automated back-merge.";
              exit 0
            fi
          fi
          if git merge --ff-only main; then
            echo "Fast-forwarded develop to main."
          else
            echo "Fast-forward not possible, creating a merge commit."
            git merge --no-ff main -m "chore(main): merge main changes back into develop"
          fi
          if git push origin develop; then
            echo "Successfully synced main into develop."
          else
            echo "WARNING: Push failed (branch protection or permissions). Create a manual PR.";
          fi
        continue-on-error: true